import logging
import random
from typing import List, Tuple, Dict, Any
from .utils import create_logic_json

logger = logging.getLogger(__name__)

def run_exploit_phase(
    strategy: Any, # EEDStrategy type hinting causes circular import if strict
    llm: Any,
    exploit_candidates: List[Dict[str, Any]],
    k_exploit: int,
    task_def: str,
    context: Dict[str, Any]
) -> Tuple[List[Dict[str, Any]], List[str], List[Dict[str, Any]]]:
    """
    Exploitフェーズ: 高スコア個体の改善
    
    Args:
        strategy: 呼び出し元のEEDStrategyインスタンス(プロンプト参照用)
        llm: LLMインターフェース
        exploit_candidates: 親となる候補リスト
        k_exploit: 生成する個体数
        task_def: タスク定義
        context: コンテキスト
        
    Returns:
        tuple: (生成されたテキストリスト, 改善に使用したGradientリスト, 親となった個体リスト)
    """
    logger.info(f"--- Exploit Phase (k={k_exploit}) ---")
    
    constraint = strategy._get_task_constraint(context)
    gradient_max_words = 100 
    
    generated_texts = []
    parent_gradients = []
    used_parents = []
    
    # 割り当て: 各親から均等に子を作る
    # k_exploit が 3 で parentが2なら、[p0, p1, p0] のように割り振る
    assignments = []
    parent_indices = list(range(len(exploit_candidates)))
    if not parent_indices:
        return [], [], []
        
    for i in range(k_exploit):
        p_idx = parent_indices[i % len(parent_indices)]
        assignments.append(exploit_candidates[p_idx])

    for parent in assignments:
        try:
            # 1. Gradient Generation
            grad_prompt = strategy.prompts["exploit_gradient_prompt"].format(
                constraint=constraint,
                task_def=task_def,
                parent_text=parent['text'],
                score=parent['score'],
                gradient_max_words=gradient_max_words
            )
            gradient = strategy._generate_with_retry(llm, grad_prompt, context).strip()
            
            # 2. Text Update
            update_prompt = strategy.prompts["update_prompt"].format(
                constraint=constraint,
                task_def=task_def,
                parent_text=parent['text'],
                gradient=gradient
            )
            
            # 3. Generate New Text
            new_text = strategy._generate_with_retry(llm, update_prompt, context).strip()
            
            logic = create_logic_json(
                phase="Exploit",
                parent_text=parent['text'][:100] + "...",
                instruction=gradient,
                meta={
                    "parent_score": parent['score'],
                    "gradient": gradient
                }
            )
            
            generated_texts.append((new_text, logic))
            parent_gradients.append(gradient) # 後でContrastiveに使う
            used_parents.append(parent)
            
        except Exception as e:
            logger.error(f"Error in Exploit Phase: {e}")
            continue
            
    return generated_texts, parent_gradients, used_parents
