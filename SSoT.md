## 1. 概要
遺伝的アルゴリズム (Genetic Algorithm) を用いて、テキストの品質を反復的に向上させるための実験用リポジトリを作成する。
参考: [DLN (Deep RFL)](https://arxiv.org/pdf/2211.01910) - ※本プロジェクトはプロンプト最適化ではなく、**テキストそのものの品質向上**（または評価者への適合度向上）を目的とする。

## 2. システム構成
### 2.1. 動作環境
- **Docker**: コンテナ内で動作。ビルドスクリプトを提供。
- **LLM**: 外部API (OpenAI等) を利用。
  - 将来的な差し替えを考慮し、LLM利用部分は抽象化層(Interface/Adapter)を設ける。

### 2.2. 設定管理と実行パイプライン
- **設定管理**: 実験設定はCSVファイルで管理する。
  - CSVには実験ID、最大世代数、個体数 `k`、モデル名、その他ハイパーパラメータ等を定義。
- **パイプライン生成**: CSVファイルを読み込み、実験実行用のシェルスクリプトを生成するスクリプト (`cmd/generate_pipeline.py` 等) を作成する。
  - 生成されたパイプラインスクリプトを実行することで実験を行う。
- **冪等性 (Skip)**: 各実験の最終成果物が既に存在する場合、その実験ステップはスキップされる仕組みとする。

### 2.3. ディレクトリ構成
```
.
├── src/                # ソースコード
├── cmd/                # 実行用シェルスクリプト
│   ├── generate_next_step.sh
│   ├── evaluate_step.sh
│   └── generate_pipeline.py  # CSVから実行スクリプトを生成
├── tests/              # テストコード
├── config/
│   └── experiments.csv # 実験設定一覧
└── result/             # 実験結果出力
    └── [実験設定ID]/   # 実行時の引数で指定
        ├── logs/       # ログ・コスト管理
        │   ├── execution.log
        │   └── token_usage.json
        └── iter[N]/    # 第N世代
            ├── input_prompts/  # テキスト生成に使用したプロンプト(Input)
            │   ├── input_prompt1
            │   └── ...
            ├── texts/          # 生成されたテキスト(Output)
            │   ├── text1
            │   └── ...
            └── metrics.json
```

## 3. ロジックとワークフロー
実験は「世代 (Generation)」単位で進行する。
- **終了条件**: ユーザーが設定したサイクル数（世代数）に達したら終了。
- **再開機能**: 実験が中断された場合でも、途中から再開可能とする（既存の世代がある場合はスキップして次から開始）。

### 3.1. テキスト生成 (`cmd/generate_next_step.sh`)
- **入力**: 
  - 履歴、評価 (`metrics.json`)、実験設定ID
- **処理**:
  - **初期化 (n=0)**: 履歴なしの場合、初期候補を生成。
  - **更新 (n>0)**: 過去の評価に基づき、遺伝的アルゴリズム/LLMで次世代候補 `k` 個を生成。
- **出力**:
  - `result/[setting]/iter[n+1]/texts/` (生成テキスト)
  - `result/[setting]/iter[n+1]/input_prompts/` (生成プロンプト)

### 3.2. 評価 (`cmd/evaluate_step.sh`)
- **入力**: 第`n+1`世代テキスト
- **処理**: 所定基準でスコアリング。
- **出力**: `result/[setting]/iter[n+1]/metrics.json`
- **Metricsスキーマ**: 各プロンプトサンプルに対応したスコアのみを単純にリスト等の形式で保持する。

## 4. サンプルタスク
**タスク名**: ポケモン推測ゲーム (Pokemon Guessing Game)
- GeneratorがEvaluatorの隠された嗜好（例：炎タイプ好き）を、点数フィードバックのみから学習し、適合するテキストを生成することを目指す。

## 5. 非機能要件
### 5.1. エラーハンドリング
- **リトライ**: 外部API呼び出し等は **最大3回** までリトライを行う。
- **停止**: 3回失敗した場合はエラーとしてプロセスを停止する。

### 5.2. ログ・コスト管理
- **ログ**: 実行ログ（APIレスポンス等含む）を `result/[setting]/logs/` 配下に保存。
- **トークン数**: 消費したトークン数を記録し、同ディレクトリに保存可能な形式で出力する。
